// ktour - simple depth first search to find knight's tour
// this version has Clint's alternative knight move order

#include <stdint.h>
#include <stdio.h>
#include <string.h>

#define DEBUG 1

/* given a square, return squares knight can go next */
short int sq_to_moves[64][8] = {
/* sq0 (0,0) */  { 17,10,-1,-1,-1,-1,-1,-1 },
/* sq1 (0,1) */  { 16,18,11,-1,-1,-1,-1,-1 },
/* sq2 (0,2) */  { 17,19,8,12,-1,-1,-1,-1 },
/* sq3 (0,3) */  { 18,20,9,13,-1,-1,-1,-1 },
/* sq4 (0,4) */  { 19,21,10,14,-1,-1,-1,-1 },
/* sq5 (0,5) */  { 20,22,11,15,-1,-1,-1,-1 },
/* sq6 (0,6) */  { 21,23,12,-1,-1,-1,-1,-1 },
/* sq7 (0,7) */  { 22,13,-1,-1,-1,-1,-1,-1 },
/* sq8 (1,0) */  { 25,18,2,-1,-1,-1,-1,-1 },
/* sq9 (1,1) */  { 24,26,19,3,-1,-1,-1,-1 },
/* sq10 (1,2) */  { 25,27,16,20,0,4,-1,-1 },
/* sq11 (1,3) */  { 26,28,17,21,1,5,-1,-1 },
/* sq12 (1,4) */  { 27,29,18,22,2,6,-1,-1 },
/* sq13 (1,5) */  { 28,30,19,23,3,7,-1,-1 },
/* sq14 (1,6) */  { 29,31,20,4,-1,-1,-1,-1 },
/* sq15 (1,7) */  { 30,21,5,-1,-1,-1,-1,-1 },
/* sq16 (2,0) */  { 33,26,10,1,-1,-1,-1,-1 },
/* sq17 (2,1) */  { 32,34,27,11,0,2,-1,-1 },
/* sq18 (2,2) */  { 33,35,24,28,8,12,1,3 },
/* sq19 (2,3) */  { 34,36,25,29,9,13,2,4 },
/* sq20 (2,4) */  { 35,37,26,30,10,14,3,5 },
/* sq21 (2,5) */  { 36,38,27,31,11,15,4,6 },
/* sq22 (2,6) */  { 37,39,28,12,5,7,-1,-1 },
/* sq23 (2,7) */  { 38,29,13,6,-1,-1,-1,-1 },
/* sq24 (3,0) */  { 41,34,18,9,-1,-1,-1,-1 },
/* sq25 (3,1) */  { 40,42,35,19,8,10,-1,-1 },
/* sq26 (3,2) */  { 41,43,32,36,16,20,9,11 },
/* sq27 (3,3) */  { 42,44,33,37,17,21,10,12 },
/* sq28 (3,4) */  { 43,45,34,38,18,22,11,13 },
/* sq29 (3,5) */  { 44,46,35,39,19,23,12,14 },
/* sq30 (3,6) */  { 45,47,36,20,13,15,-1,-1 },
/* sq31 (3,7) */  { 46,37,21,14,-1,-1,-1,-1 },
/* sq32 (4,0) */  { 49,42,26,17,-1,-1,-1,-1 },
/* sq33 (4,1) */  { 48,50,43,27,16,18,-1,-1 },
/* sq34 (4,2) */  { 49,51,40,44,24,28,17,19 },
/* sq35 (4,3) */  { 50,52,41,45,25,29,18,20 },
/* sq36 (4,4) */  { 51,53,42,46,26,30,19,21 },
/* sq37 (4,5) */  { 52,54,43,47,27,31,20,22 },
/* sq38 (4,6) */  { 53,55,44,28,21,23,-1,-1 },
/* sq39 (4,7) */  { 54,45,29,22,-1,-1,-1,-1 },
/* sq40 (5,0) */  { 57,50,34,25,-1,-1,-1,-1 },
/* sq41 (5,1) */  { 56,58,51,35,24,26,-1,-1 },
/* sq42 (5,2) */  { 57,59,48,52,32,36,25,27 },
/* sq43 (5,3) */  { 58,60,49,53,33,37,26,28 },
/* sq44 (5,4) */  { 59,61,50,54,34,38,27,29 },
/* sq45 (5,5) */  { 60,62,51,55,35,39,28,30 },
/* sq46 (5,6) */  { 61,63,52,36,29,31,-1,-1 },
/* sq47 (5,7) */  { 62,53,37,30,-1,-1,-1,-1 },
/* sq48 (6,0) */  { 58,42,33,-1,-1,-1,-1,-1 },
/* sq49 (6,1) */  { 59,43,32,34,-1,-1,-1,-1 },
/* sq50 (6,2) */  { 56,60,40,44,33,35,-1,-1 },
/* sq51 (6,3) */  { 57,61,41,45,34,36,-1,-1 },
/* sq52 (6,4) */  { 58,62,42,46,35,37,-1,-1 },
/* sq53 (6,5) */  { 59,63,43,47,36,38,-1,-1 },
/* sq54 (6,6) */  { 60,44,37,39,-1,-1,-1,-1 },
/* sq55 (6,7) */  { 61,45,38,-1,-1,-1,-1,-1 },
/* sq56 (7,0) */  { 50,41,-1,-1,-1,-1,-1,-1 },
/* sq57 (7,1) */  { 51,40,42,-1,-1,-1,-1,-1 },
/* sq58 (7,2) */  { 48,52,41,43,-1,-1,-1,-1 },
/* sq59 (7,3) */  { 49,53,42,44,-1,-1,-1,-1 },
/* sq60 (7,4) */  { 50,54,43,45,-1,-1,-1,-1 },
/* sq61 (7,5) */  { 51,55,44,46,-1,-1,-1,-1 },
/* sq62 (7,6) */  { 52,45,47,-1,-1,-1,-1,-1 },
/* sq63 (7,7) */  { 53,46,-1,-1,-1,-1,-1,-1 }
};

uint8_t sq_to_moves_n[64] = {
    2,3,4,4,4,4,3,2,3,4,6,6,6,6,4,3,4,6,8,8,8,8,6,4,4,6,8,8,8,8,6,4,
    4,6,8,8,8,8,6,4,4,6,8,8,8,8,6,4,3,4,6,6,6,6,4,3,2,3,4,4,4,4,3,2 
};

int failCount =0;
int movenum_to_sq[64];

int
search(int depth, int sq, uint64_t visited)
{
    int i;
    
    visited |= (((uint64_t)1)<<sq);

    /* base case: all squares visited? tour complete! */
    if(visited == 0xFFFFFFFFFFFFFFFF) {
        movenum_to_sq[depth] = sq;
        return 0;
    }

    /* try all moves */
    for(i=0; i<sq_to_moves_n[sq]; i++) {
        short int candidate = sq_to_moves[sq][i];

        /* already visited this square? */
        if(visited & (((uint64_t)1)<<candidate)) {
            continue;
        }

        if(0 == search(depth+1, candidate, visited)) {
            movenum_to_sq[depth] = sq;
            return 0;
        }
    }

    if(0 == (failCount % 10)) {
        printf("failCount: %d\n", failCount++);
    }

    return -1;
}

/* from square sq, generate next moves */
int 
main(int ac, char **av)
{
    int rc;
    int sq_to_movenum[64];

    /* start search */
    rc = search(    0, /* depth */ 
                        0, /* destination square */
                        1 /* visited bitmap */
                    );

    /* did succeed? */
    if(rc == 0) {
        int i, row, col;
        for(i=0; i<64; ++i) {
            sq_to_movenum[movenum_to_sq[i]] = i;
        }
        for(row=0; row<8; ++row) {
            printf("+--+--+--+--+--+--+--+--+\n");
            printf("|");
            for(col=0; col<8; ++col) {
                printf("%2d|", sq_to_movenum[row*8+col]);
            }
            printf("\n");
        }
        printf("+--+--+--+--+--+--+--+--+\n");
    }
    else {
        printf("FAILED\n");
    }
}
